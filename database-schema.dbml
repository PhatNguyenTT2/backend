// Database Schema for Inventory Management System
// Generated: November 4, 2025
// Total Models: 21
// Updated: Added POS PIN Authentication fields to Employee table

// ===========================
// USER MANAGEMENT
// ===========================

Table UserAccount {
  _id ObjectId [pk]
  userCode String [unique, note: 'Auto: USER2025000001']
  username String [unique, not null]
  email String [unique, not null]
  passwordHash String [not null]
  role ObjectId [ref: > Role._id]
  isActive Boolean [default: true]
  tokens Array [note: 'JWT tokens array']
  lastLogin Date
  
  Indexes {
    userCode
    username
    email
    role
    isActive
  }
}

Table Employee {
  _id ObjectId [pk]
  userAccount ObjectId [unique, ref: - UserAccount._id, note: '1-1 relationship']
  fullName String [not null]
  department ObjectId [ref: > Department._id]
  phone String
  address String
  dateOfBirth Date
  
  // POS Authentication Fields (NEW)
  posPinHash String [note: 'Hashed PIN (bcrypt), 4-6 digits, select: false']
  pinLastChanged Date [default: 'now', note: 'Last PIN change timestamp']
  pinExpiresAt Date [note: 'PIN expiry date (90 days from last change)']
  pinFailedAttempts Number [default: 0, note: 'Failed login attempts counter']
  pinLockedUntil Date [note: 'Lock timestamp after 5 failed attempts']
  posLastLogin Date [note: 'Last POS login timestamp']
  posDeviceId String [note: 'Associated POS device ID (optional)']
  canAccessPOS Boolean [default: false, note: 'Permission to use POS system']
  
  Note: '''
    POS PIN Rules:
    - 4-6 digits only
    - Hashed with bcrypt (same as password)
    - Lock after 5 failed attempts for 15 minutes
    - Expire after 90 days
    - Default PIN: 1234 (must change on first login)
  '''
  
  Indexes {
    userAccount
    department
    canAccessPOS
    posDeviceId
    posLastLogin
  }
}

Table Role {
  _id ObjectId [pk]
  roleCode String [unique, note: 'Auto: ROLE2025000001']
  roleName String [unique, not null]
  description String
  permissions Array [note: 'Array of permission strings']

  Indexes {
    roleCode
    roleName
  }
}

// ===========================
// ORGANIZATION
// ===========================

Table Department {
  _id ObjectId [pk]
  departmentCode String [unique, note: 'Auto: DEPT2025000001']
  departmentName String [unique, not null]
  description String
  manager ObjectId [ref: > Employee._id]
  location String
  phone String
  email String
  isActive Boolean [default: true]
  
  Indexes {
    departmentCode
    departmentName
    manager
    isActive
  }
}

// ===========================
// PRODUCT MANAGEMENT
// ===========================

Table Product {
  _id ObjectId [pk]
  productCode String [unique, note: 'Auto: PROD2025000001']
  name String [not null]
  category ObjectId [ref: > Category._id]
  costPrice Decimal128 [not null]
  originalPrice Decimal128 [not null]
  discountPercentage Decimal128 [default: 0]
  isActive Boolean [default: true]
  vendor String
  
  Note: 'Virtual: sellPrice = originalPrice * (1 - discountPercentage/100)'
  
  Indexes {
    productCode
    name
    category
    isActive
    costPrice
    originalPrice
  }
}

Table DetailProduct {
  _id ObjectId [pk]
  product ObjectId [unique, ref: - Product._id, note: '1-1 relationship']
  image String
  description String
  
  Indexes {
    product
  }
}

Table Category {
  _id ObjectId [pk]
  categoryCode String [unique, note: 'Auto: CAT2025000001']
  name String [unique, not null]
  image String
  description String
  isActive Boolean [default: true]
  
  Indexes {
    categoryCode
    name
    isActive
  }
}

Table ProductBatch {
  _id ObjectId [pk]
  product ObjectId [ref: > Product._id]
  batchCode String [unique, note: 'Auto: BATCH2025000001']
  mfgDate Date
  expiryDate Date
  quantity Number [not null, default: 0]
  status String [note: 'active, expired, disposed', default: 'active']
  notes String
  
  Note: 'Virtual: isExpired, daysUntilExpiry, isNearExpiry'
  
  Indexes {
    product
    batchCode
    status
    expiryDate
  }
}

// ===========================
// INVENTORY MANAGEMENT
// ===========================

Table Inventory {
  _id ObjectId [pk]
  product ObjectId [unique, ref: - Product._id, note: '1-1 relationship']
  quantityOnHand Number [default: 0]
  quantityReserved Number [default: 0]
  quantityOnShelf Number [default: 0]
  reorderPoint Number [default: 10]
  warehouseLocation String  
  
  Indexes {
    product
    quantityOnHand
    reorderPoint
  }
}

Table InventoryMovement {
  _id ObjectId [pk]
  movementNumber String [unique, note: 'Auto: MOV2025000001']
  product ObjectId [ref: > Product._id]
  inventory ObjectId [ref: > Inventory._id]
  movementType String [note: 'in, out, adjustment, transfer', not null]
  quantity Number [not null]
  reason String
  date Date [not null]
  performedBy ObjectId [ref: > Employee._id]
  purchaseOrderId ObjectId [ref: > PurchaseOrder._id]
  notes String
  
  Indexes {
    movementNumber
    product
    inventory
    movementType
    date
    performedBy
  }
}

// ===========================
// CUSTOMER MANAGEMENT
// ===========================

Table Customer {
  _id ObjectId [pk]
  customerCode String [unique, note: 'Auto: CUST2025000001']
  fullName String [not null]
  email String
  phone String
  address String
  dateOfBirth Date
  gender String [note: 'male, female, other']
  isActive Boolean [default: true]

  Indexes {
    customerCode
    fullName
    email
    phone
    isActive
  }
}

Table DetailCustomer {
  _id ObjectId [pk]
  customer ObjectId [unique, ref: - Customer._id, note: '1-1 relationship']
  customerType String [note: 'guest, retail, wholesale, vip', default: 'guest']
  totalSpent Decimal128 [default: 0]
  notes String
  
  Indexes {
    customer
    customerType
    totalSpent
  }
}

// ===========================
// SUPPLIER MANAGEMENT
// ===========================

Table Supplier {
  _id ObjectId [pk]
  supplierCode String [unique, note: 'Auto: SUP2025000001']
  companyName String [not null]
  email String
  phone String
  address String
  isActive Boolean [default: true]
  
  Indexes {
    supplierCode
    companyName
    email
    phone
    isActive
  }
}

Table DetailSupplier {
  _id ObjectId [pk]
  supplier ObjectId [unique, ref: - Supplier._id, note: '1-1 relationship']
  bankName String
  accountNumber String
  paymentTerms String [note: 'cod, net15, net30, net60, net90', default: 'net30']
  creditLimit Decimal128 [default: 0]
  currentDebt Decimal128 [default: 0]
  notes String
  
  Note: 'Virtual: availableCredit = creditLimit - currentDebt'
  
  Indexes {
    supplier
    currentDebt
  }
}

// ===========================
// SALES ORDER MANAGEMENT
// ===========================

Table Order {
  _id ObjectId [pk]
  orderNumber String [unique, note: 'Auto: ORD2501000001']
  customer ObjectId [ref: > Customer._id]
  createdBy ObjectId [ref: > Employee._id]
  orderDate Date [not null, default: 'now']
  deliveryType String [note: 'delivery, pickup', default: 'delivery']
  address String
  shippingFee Decimal128 [default: 0]
  discountPercentage Number [default: 0]
  total Decimal128 [default: 0, note: 'Stored calculated value']
  paymentStatus String [note: 'pending, paid, failed, refunded', default: 'pending']
  status String [note: 'pending, processing, shipping, delivered, cancelled', default: 'pending']
  
  Note: 'Virtual: subtotal (from details), discountAmount'
  
  Indexes {
    orderNumber
    (customer, orderDate)
    (createdBy, orderDate)
    status
    paymentStatus
    orderDate
    total
  }
}

Table OrderDetail {
  _id ObjectId [pk]
  order ObjectId [ref: > Order._id]
  product ObjectId [ref: > Product._id]
  quantity Number [not null]
  unitPrice Decimal128 [not null]
  total Decimal128 [note: 'quantity * unitPrice']
  notes String
  
  Note: 'Auto-updates Order.total on save/delete'
  
  Indexes {
    order
    product
  }
}

Table Payment {
  _id ObjectId [pk]
  paymentNumber String [unique, note: 'Auto: PAY2025000001']
  paymentType String [note: 'sales, purchase', not null]
  relatedOrderId ObjectId [note: 'Polymorphic: Order or PurchaseOrder']
  amount Decimal128 [not null]
  paymentMethod String [note: 'cash, card, bank_transfer, e_wallet, check, credit', not null]
  paymentDate Date [not null]
  status String [note: 'pending, completed, failed, refunded, cancelled', default: 'pending']
  customer ObjectId [ref: > Customer._id, note: 'For sales payments']
  supplier ObjectId [ref: > Supplier._id, note: 'For purchase payments']
  receivedBy ObjectId [ref: > Employee._id]
  notes String
  
  Note: 'Virtual: relatedOrder (dynamic populate based on paymentType)'
  
  Indexes {
    paymentNumber
    paymentType
    relatedOrderId
    paymentDate
    status
    customer
    supplier
  }
}

// ===========================
// PURCHASE ORDER MANAGEMENT
// ===========================

Table PurchaseOrder {
  _id ObjectId [pk]
  poNumber String [unique, note: 'Auto: PO2025000001']
  supplier ObjectId [ref: > Supplier._id, not null]
  orderDate Date [not null, default: 'now']
  expectedDeliveryDate Date
  shippingFee Decimal128 [default: 0]
  discountPercentage Decimal128 [default: 0]
  totalPrice Decimal128 [default: 0, note: 'Stored calculated value']
  status String [note: 'pending, approved, received, cancelled', default: 'pending']
  paymentStatus String [note: 'unpaid, partial, paid', default: 'unpaid']
  notes String
  createdBy ObjectId [ref: > Employee._id]
  
  Note: 'Virtual: subtotal (from details), discountAmount'
  
  Indexes {
    poNumber
    supplier
    status
    paymentStatus
    orderDate
  }
}

Table DetailPurchaseOrder {
  _id ObjectId [pk]
  purchaseOrder ObjectId [ref: > PurchaseOrder._id]
  product ObjectId [ref: > Product._id]
  quantity Number [not null]
  unitPrice Decimal128 [not null]
  total Decimal128 [note: 'quantity * unitPrice']
  
  Note: 'Auto-updates PurchaseOrder.totalPrice on save/delete'
  
  Indexes {
    purchaseOrder
    product
  }
}

Table StockOutOrder {
  _id ObjectId [pk]
  soNumber String [unique, note: 'Auto: SO2025000001']
  orderDate Date [not null, default: 'now']
  expectedDeliveryDate Date
  shippingFee Decimal128 [default: 0]
  discountPercentage Decimal128 [default: 0]
  totalPrice Decimal128 [default: 0, note: 'Stored calculated value']
  status String [note: 'pending, processing, completed, cancelled', default: 'pending']
  paymentStatus String [note: 'unpaid, partial, paid', default: 'unpaid']
  notes String
  createdBy ObjectId [ref: > Employee._id]
  
  Note: 'Virtual: subtotal (from details), discountAmount'
  
  Indexes {
    soNumber
    status
    paymentStatus
    orderDate
  }
}

Table DetailStockOutOrder {
  _id ObjectId [pk]
  stockOutOrder ObjectId [ref: > StockOutOrder._id]
  product ObjectId [ref: > Product._id]
  quantity Number [not null]
  unitPrice Decimal128 [not null]
  total Decimal128 [note: 'quantity * unitPrice']
  
  Note: 'Auto-updates StockOutOrder.totalPrice on save/delete'
  
  Indexes {
    stockOutOrder
    product
  }
}

// ===========================
// RELATIONSHIPS SUMMARY
// ===========================

// User Management
// - UserAccount 1-1 Employee
// - UserAccount N-1 Role
// - Employee N-1 Department
// - Department 1-1 Employee (manager)

// Product Management
// - Product 1-1 DetailProduct
// - Product 1-1 Inventory
// - Product N-1 Category
// - Product 1-N ProductBatch
// - Product 1-N InventoryMovement

// Customer Management
// - Customer 1-1 DetailCustomer
// - Customer 1-N Order

// Supplier Management
// - Supplier 1-1 DetailSupplier
// - Supplier 1-N PurchaseOrder

// Order Management
// - Order 1-N OrderDetail
// - Order N-1 Customer
// - Order N-1 Employee (createdBy)
// - OrderDetail N-1 Product

// Purchase Order Management
// - PurchaseOrder 1-N DetailPurchaseOrder
// - PurchaseOrder N-1 Supplier
// - PurchaseOrder N-1 Employee (createdBy)
// - DetailPurchaseOrder N-1 Product

// Stock Out Order Management
// - StockOutOrder 1-N DetailStockOutOrder
// - StockOutOrder N-1 Employee (createdBy)
// - DetailStockOutOrder N-1 Product

// Payment Management (Polymorphic)
// - Payment N-1 Customer (if sales)
// - Payment N-1 Supplier (if purchase)
// - Payment N-1 Employee (receivedBy)
// - Payment polymorphic to Order or PurchaseOrder

// Inventory Management
// - InventoryMovement N-1 Product
// - InventoryMovement N-1 Inventory
// - InventoryMovement N-1 Employee (performedBy)
// - InventoryMovement N-1 PurchaseOrder (optional)
